# 部署有状态的多副本应用

> replicaSet 是通过一个POD模板创建多个pod 副本。这些副本出了他们的IP地址和名字不同外,没有别的差异。如果pod模板描述了一个关联到特定pvc的pv,那么rs的所有pod 都绑定到同一个pv上。一个比较取巧的做法是,让不同的POD使用同一个卷的不同数据目录,或者直接创建多个replicatSet,且同时创建多个Service。***这种解决方案不仅令人厌恶,而且也不是一个完美的解决办法***,因为每个pod 没法知道其他POD 对应的service IP。各个service 之间毫无关联，k8s针对此设计出了 statefulSet

## 对比 statefulSet 和 ReplicaSet

> 提出了牛(工具)和宠物的区别,一个工具坏了,很容易直接购买到标准的物品,正如一头牛死了,还有其他牛可以干活,找到替代的也不难没有必要找原先那头牛。而一只宠物挂了,很难再找到一只一模一样特征的了,所以重新找的副本需要具有和以前宠物相似的特征

|    类别    | 副本名称 | 独立持久卷 | 网络标识 |    扩缩容    | 创建顺序 | 节点调度 |
| :---------: | :------: | :--------: | :------: | :----------: | :------: | :------: |
| replicatSet |   随机   |     否     |    无    |    无规律    |  无规律  |  无规律  |
| StatefulSet |  有顺序  |     是     |   SRV   | 最高节点阔缩容 | 从低到高 |  无规律  |

## 总结
* 当一个有状态的pod挂掉之后,这个POD实例需要在其他节点重建,但是新的实力必须与被替换的实例拥有相同的名称,网络,标识和状态。
* statefulSet创建的所有pod副本并不是完全一样的。每个POD都可以拥有一组独立的数据卷。
* POD 的名字是有规律的，依照一个从0开始的顺序索引。
* 同时每个POD都有自己的DNS记录这样方便statfulSet内部的成员相互发现。
* 当缩容时,默认缩容顺序最大的机器,所以若此时有一个相关的POD不正常,缩容无法成功。
* 通过SRV可以查找statefulSet 的伙伴节点
* 当节点发生故障时,此时该节点的kubelet 无法与master 通信，pod 状态会被标记为unknown。当unknown 持续超过一段时间后，会自动被删除的方式驱逐（但是在不可通信的节点上可能这个pod 仍旧正常运行着，因为kubelet 再也接受不到api-server的通知了）,此时应该使用强制删除的命令删除POD

## 一些常用的命令

```bash
# 强制删除失联的节点
kubectl delete po [app] --force --grace-period 0
```
